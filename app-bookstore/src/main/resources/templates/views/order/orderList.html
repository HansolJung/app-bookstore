<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/main_layout}">
<th:block layout:fragment="css">
    <link rel="stylesheet" href="/css/admin/list.css">
</th:block>
<div layout:fragment="content">
    <main class="container">
        <section class="contents">
            <header class="text-center">
                <h2>나의 주문 내역 리스트</h2>
            </header>
            <section class="table-list">
                <input type="hidden" id="userId" name="userId" th:value="${userId}">
                <input type="hidden" id="page" name="page" th:value="${data.page}">
                <input type="hidden" id="size" name="size" value="10">
                <table class="admin-table">
                    <colgroup>
                        <col style="width: 10%;" />
                        <col style="width: 15%;" />
                        <col style="width: 15%;" />
                        <col style="width: 15%;" />
                        <col style="width: 15%;" />
                        <col style="width: 30%;" />
                    </colgroup>
                    <thead class="dark">
                        <tr>
                            <th>주문번호</th>
                            <th>주문자 아이디</th>
                            <th>주문자 이름</th>
                            <th>총액</th>
                            <th>상태</th>
                            <th>주문일시</th>
                        </tr>
                    </thead>
                    <tbody id="orderTbody">
                        <tr th:each="item : ${data.content}"
                            th:style="${#strings.equals(item.status, '주문취소') ? 'background-color: gray;' : (#strings.equals(item.status, '배송완료') ? 'background-color: forestgreen;' : '')}">
                            <td>
                                <a href="javascript:void(0)" th:onclick="goDetail([[${item.orderId}]])"
                                    th:text="${item.orderId}"></a>
                            </td>
                            <td th:text="${item.userId}"></td>
                            <td th:text="${item.userName}"></td>
                            <td th:text="${item.totalPrice}"></td>
                            <td th:text="${item.status}"></td>
                            <td th:text="${#temporals.format(item.orderDate, 'yyyy-MM-dd HH:mm:ss')}"></td>
                        </tr>
                    </tbody>
                </table>
            </section>
            <section>
                <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-center" id="pageArea" th:utext="${data.pageHTML}">
                    </ul>
                </nav>
            </section>
        </section>
    </main>
    <script>

        function goDetail(bookId) {
            location.href = `/order/detail/${bookId}`;
        }

        function movePage(page) {
            $('#page').val(page);
            getSearchData();
        }

        function makeSearchParam() {
            return {
                page: $('#page').val(),
                size: $('#size').val(),
            }
        }

        async function getSearchData() {
            const userId = $('#userId').val();
            const res = await axios.get(`/api/v1/order/list/${userId}`, { params: makeSearchParam() });
            drawList(res.data);
        }

        const columns = ['orderId', 'userId', 'userName', 'totalPrice', 'status', 'orderDate'];

        function drawList(data) {
            const orderTbody = $('#orderTbody');
            const pageArea = $('#pageArea');

            orderTbody.empty();
            pageArea.empty();

            $.each(data.content, (index, obj) => {

                const tr = $('<tr></tr>');

                if (obj.status === '주문취소') {   // 상태가 주문취소일 경우
                    tr.css({ "background-color": "gray" });  // 배경 색깔 변경
                } else if (obj.status === '배송완료') {   // 상태가 배송완료일 경우
                    tr.css({ "background-color": "forestgreen" });  // 배경 색깔 변경하고 클릭 막기
                }

                let contents = '';
                for (let key of columns) {     // key - value 로 이뤄진 객체에서 in 절을 쓰면 key 를 가져온다. 배열에서 of 절을 쓰면 그냥 값을 가져온다.
                    const td = $('<td></td>');
                    contents = obj[key];

                    // if (key === 'userId') {
                    //     const aTag = $('<a href="javascript:void(0)"></a>');
                    //     aTag.on('click', () => goDetail(obj[key]));
                    //     aTag.text(obj[key]);
                    //     contents = aTag;
                    // } else {
                    //     contents = obj[key];
                    // }
                    td.append(contents);
                    tr.append(td);
                }
                orderTbody.append(tr);
            });

            pageArea.append(data.pageHTML);
        }
    </script>
</div>

</html>